---
id: docs_13
title: 数据结构和存储
sidebar_label: 数据结构和存储
---

Simplechain的区块、交易等数据最终都是存储在`Level DB`数据库中。`Level DB` 数据库是一个键值对（ key-value ）数据库， key一般与散列相关，value则是存储内容的RLP编码。

## 数据组织形式

Simplechain 使用了MPT树（Merkle Patricia Trie），作为数据组织形式，用来组织管理用户的账户状态、交易信息等重要数据。MMPT是一种加密认证的数据结构，它融合了Merkle树和Trie树（前缀树）两种数据类型的优点。

## Merkle树

Merkle树是一种树形数据结构，可以是二叉树，也可以是多叉树。它由一组叶节点、一组中间节点和一个根节点构成。最下面的叶节点包含基础数据，每个中间节点是它的子节点的散列，根节点是它的子节点的散列，代表了Merkle树的根部。

创建Merkle树的目的是允许区块的数据可以零散地传送；节点可以从一个节点下载区块头，从另外的源下载与其相关的树的其他部分，而依然能够确认所有的数据都是正确的。

Merkle树可以用来存储所有键值对，Merkle树具有下列特性：

1. 每个数据集对应一个唯一合法的根散列值。
2. 很容易更新、添加或者删除树节点，以及生成新的根散列值。
3. 不改变根散列值的话就没有办法修改树的任何部分，所以如果根散列值被包括在签名的文档或有效区块中，就可以保证这棵树的正确性。
4. 任何人可以只提供一个到特定节点的分支，并通过密码学方法证明拥有对应内容的节点确实在树里。

## Trie树

key代表的是从树根到对应value的一条路径。即从根节点开始， key 中的每个字符（从前到后）都代表着从根节点出发寻找相应value 所要经过的子节点。value 存储在叶节点中，是每条路径的最终节点。

## MPT树

结合merkle和Trie,并做了以下改进：

1. 为了保证树的加密安全，每个节点通过它的散列值被引用
2. 对于存储在Leve IDB 数据库中的非叶节点，key代表着节点的RLP编码的SHA3散列值， value是节点的RLP编码。
3. 引入了很多节点类型来提高效率：
   > 3.1 空节点：简单的表示空，在代码中就是一个空串  

   > 3.2叶节点：键值对的一个列表，其中key是一种特殊的十六进制编码， value是RLP编码。

   > 3.3扩展节点：键值对的列表，但是这里的value 是其他节点的散列值，通过这个散列值可以链接到其他节点。 

   > 3.4分支节点：一个长度为17 的列表。MPT 中的key 被编码成一种特殊的十六进制的表示，再加上最后的value ，前16 个元素对应key 中的16 个可能的十六进制字符，如果有一个键值对在这个分支节点终止，则最后一个元素代表一个值，即分支节点既可以是搜索路径的终止，也可以是路径的中间节点。
4. 用于对key 进行编码的特殊十六进制前缀编码（ HP ）

## 三颗树

Simplechain的区块头就是使用三颗树

## 状态树

状态树包含一个键值映射，其中键是账户地址，值是账户内容，主要是｛ nonce, balance,codeHash, storageRoot ｝ 。nonce 是账户交易的序数， balance 是账户余额， codeHash 是代码的散列值， storageRoot 是另一棵树的根节点。状态树代表访问区块后的整个状态。

Simplechain 是一个以账户为基础的区块链应用平台，账户的状态不是直接存储在每个区块中，所有的账户状态都是以“状态数据”的形式存储在Simplechain的节点中。

## 交易树

每个区块都有一棵独立的交易树。

区块中交易的顺序主要由“矿工”决定，在这个块被挖出前这些数据都是未知的。不过“矿工” 一般会根据交易的GasPrice 和nonce 对交易进行排序。首先会将交易列表中的交易划分到各个发送账户，每个账户的交易根据这些交易的nonce 来排序。每个账户的交易排序完成后，再通过比较每个账户的第一条交易，选出最高价格的交易，这些是通过一个堆（heap）来实现的

在交易树包含的键值对中，其中每个键是交易的编号，值是交易内容

## 收据树

每个区块都有自己的收据树，收据树不需要更新，收据树代表每笔交易相应的收据。

交易的收据是一个 `RLP` 编码的数据结构：［medstate, Gas_ used, logbloom,logs ］ 。其中， medstate 是交易处理后树根的状态； Gas_used 是交易处理后Gas 的使用量；logs 是表格［ address, [topicl, topic2 ,…], data ］元素的列表，表格由交易执行期间调用的操作码LOGO …LOG4 生成（包含主调用和子调用）， address 是生成日志的合约地址， topicn是最多4 个32 字节的值， data 是任意字节大小的数组； logbloom 是交易中所有logs 的address 和topic 组成的布隆过滤器.

## 数据库支持一一LevelDB

`LeveIDB` 是 `Google` 实现的一个非常高效的键值对数据库，其中键值都是二进制的，目前能够支持十亿级别的数据量，在这个数据量下还有着非常高的性能。Simplechain中共有三个`LeveDB`数据库，分别是 `BlockDB` 、`StateDB` 和 `ExtrasDB`。`BlockDB`保存了块的主体内容，包括块头和交易；`StateDB`保存了账户的状态数据；`ExtrasDB` 保存了收据信息和其他辅助信息。


